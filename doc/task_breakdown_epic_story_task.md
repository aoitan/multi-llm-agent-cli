# 新仕様タスク分解（Epic / Story / Task）

本ドキュメントは、新仕様を実装可能なバックログへ分解したものである。

- 参照仕様:
  - `./specification_ideal_v1.md`
  - `./spec_user_visible_behavior.md`
  - `./feature_list.md`
  - `./deployment_model_single_control_node.md`

## 1. 運用ルール

- `Epic`: 価値単位（複数Storyを含む）
- `Story`: ユーザー価値単位（受け入れ条件を持つ）
- `Task`: 実装/検証の作業単位
- すべてのStoryで「要件」「受け入れ条件」「スコープ（やる/やらない）」を定義する

---

## Epic E1: Control Node MVP基盤

### Story S1.1 CLIチャット基盤（F-001, F-003）

- 要件:
  - 単発/対話チャットが実行できる
  - モデル選択優先順（引数 > セッション > 既定）を適用できる
- スコープ（やること）:
  - `chat` コマンドの単発実行
  - 対話モードの入出力ループ
  - モデル解決ロジック
- スコープ（やらないこと）:
  - GUI化
  - 高度オーケストレーション
- 受け入れ条件:
  - 指定モデルで応答が返る
  - モデル未存在時に候補または導線を表示
  - ユーザー可視振る舞い仕様のF-001/F-003 DoDを満たす
- Tasks:
  - T1.1.1: `chat` 単発/対話のコマンドハンドラ実装
  - T1.1.2: モデル解決優先順の実装
  - T1.1.3: エラーメッセージ（モデル未存在）整備
  - T1.1.4: 受け入れテスト追加

### Story S1.2 ストリーミングUX（F-002）

- 要件:
  - 応答を逐次表示し、実行中状態をユーザーが認識できる
- スコープ（やること）:
  - ストリーミング逐次表示
  - `Generating...` 等の実行中表示
  - 完了明示（done表示/状態更新）
- スコープ（やらないこと）:
  - リッチUIレンダラ
- 受け入れ条件:
  - 応答の順序が崩れない
  - 実行中表示と完了表示が確認できる
  - DoD F-002適合
- Tasks:
  - T1.2.1: チャンク表示処理の実装
  - T1.2.2: 実行中/完了状態表示の実装
  - T1.2.3: ストリーミング順序保証テスト

### Story S1.3 セッション・コンテキスト（F-004, F-005）

- 要件:
  - セッション保存/復元とコンテキスト制御ができる
- スコープ（やること）:
  - `session start/save/load/end`
  - 履歴保持・明示破棄・要約圧縮の最小機能
- スコープ（やらないこと）:
  - 分散セッション同期
- 受け入れ条件:
  - 保存→復元で文脈が再利用できる
  - 圧縮/破棄が結果へ反映される
  - DoD F-004/F-005適合
- Tasks:
  - T1.3.1: セッション保存/復元機能実装
  - T1.3.2: コンテキスト管理ポリシー実装
  - T1.3.3: 回帰テスト追加

---

## Epic E2: ロールオーケストレーション（Single Control Node）

### Story S2.1 ロール実行モデル（F-101, F-102）

- 要件:
  - 論理ロールを定義し、ロール間でタスク委譲できる
- スコープ（やること）:
  - ロール定義（coordinator/developer/reviewer/documenter）
  - 親子タスクID追跡
  - Control Node内キューでの委譲
- スコープ（やらないこと）:
  - リモートAgent常駐
  - ノード間Agent通信
- 受け入れ条件:
  - どのロールに委譲されたか表示・ログで追跡可能
  - 親子タスクの整合性が取れる
  - DoD F-101/F-102適合
- Tasks:
  - T2.1.1: ロール定義と責務マップ実装
  - T2.1.2: 親子タスク管理実装
  - T2.1.3: ロール委譲表示/ログ実装

### Story S2.2 並行実行と停止制御（F-103, F-105）

- 要件:
  - 複数ロールが並行実行され、ループ停止できる
- スコープ（やること）:
  - 非同期ワーカープール
  - 再試行上限/再循環上限
- スコープ（やらないこと）:
  - 分散ジョブスケジューラ導入
- 受け入れ条件:
  - ロール別処理時間と成功/失敗が可視
  - ループ閾値超過で自動停止
  - DoD F-103/F-105適合
- Tasks:
  - T2.2.1: ワーカープール実装
  - T2.2.2: ループ検知ルール実装
  - T2.2.3: 負荷・停止系テスト

---

## Epic E3: MCPツール実行基盤

### Story S3.1 MCP接続と管理（F-201, F-202）

- 要件:
  - Control Node経由でMCP利用/管理ができる
- スコープ（やること）:
  - `mcp list/enable/disable/status`
  - ツール呼び出し履歴表示
- スコープ（やらないこと）:
  - リモートノードでのMCP配布
- 受け入れ条件:
  - 管理コマンドが実行可能
  - 使用ツールが可視化される
  - DoD F-201/F-202適合
- Tasks:
  - T3.1.1: MCP管理コマンド実装
  - T3.1.2: MCP呼び出しメタ情報ログ実装
  - T3.1.3: 管理操作テスト

### Story S3.2 内製ツール3種（F-203, F-204, F-205）

- 要件:
  - `file_read`, `file_write`, `shell_exec` を安全に実行できる
- スコープ（やること）:
  - パス制限・承認制御
  - 実行中表示（特に shell）
  - 監査ログ連携
- スコープ（やらないこと）:
  - 汎用OS管理機能
- 受け入れ条件:
  - 許可/拒否理由が表示される
  - 承認が必要な操作は実行前に確認される
  - DoD F-203/F-204/F-205適合
- Tasks:
  - T3.2.1: file_read 実装 + ポリシー判定
  - T3.2.2: file_write 実装 + 上書き制御
  - T3.2.3: shell_exec 実装 + 実行中表示
  - T3.2.4: ツール実行監査イベント実装

---

## Epic E4: セキュリティ・権限モデル

### Story S4.1 認証/認可（F-401, F-402）

- 要件:
  - CLI-ControlNode/Ollama/MCP間で認証され、未認可操作を拒否する
- スコープ（やること）:
  - 認証トークン検証
  - ロール/ポリシー判定
- スコープ（やらないこと）:
  - OAuth等の高度認証基盤
- 受け入れ条件:
  - 未認証/未認可は一貫して拒否される
  - 過剰情報を含まないエラーメッセージ
  - DoD F-401/F-402適合
- Tasks:
  - T4.1.1: 認証ミドルウェア実装
  - T4.1.2: 認可ポリシー実装
  - T4.1.3: セキュリティ拒否系テスト

### Story S4.2 実行安全制御（F-403, F-404, F-405, F-406）

- 要件:
  - パス/コマンドを安全制御し、権限モードを明示できる
- スコープ（やること）:
  - `read-only/workspace-write/full-access`
  - `auto/ask/deny` 判定
  - 危険コマンド拒否/強制確認
- スコープ（やらないこと）:
  - 任意コマンド無制限実行
- 受け入れ条件:
  - 許可外パスは拒否される
  - `ask` は毎回承認を要求する
  - モード切替履歴が残る
  - DoD F-403/F-404/F-405/F-406適合
- Tasks:
  - T4.2.1: 権限モード管理実装
  - T4.2.2: `auto/ask/deny` 実装
  - T4.2.3: 危険コマンド判定実装
  - T4.2.4: セキュリティ監査ログ実装

---

## Epic E5: 可視性・運用性（UX + Logging + Headless）

### Story S5.1 実行状態表示統一（横断）

- 要件:
  - `pending/running/waiting_approval/succeeded/failed/cancelled` を統一表示
- スコープ（やること）:
  - 状態遷移の統一
  - CLI表示への反映
- スコープ（やらないこと）:
  - GUIダッシュボード構築
- 受け入れ条件:
  - 全主要コマンドで状態表示が一貫
  - エラー時に次アクションが提示される
- Tasks:
  - T5.1.1: 状態機械定義の統一
  - T5.1.2: 表示メッセージ統一
  - T5.1.3: UX受け入れテスト

### Story S5.2 イベント/監査/結果ログ（F-504, F-505, F-501）

- 要件:
  - 実行サマリ・イベント・監査・結果・エラー情報を追跡可能に保存
- スコープ（やること）:
  - 構造化ログ
  - 監査ログ（承認・権限変更・破壊操作）
  - エラー分類適用
- スコープ（やらないこと）:
  - 外部SIEM連携
- 受け入れ条件:
  - 事後に「誰が何をしたか」追跡できる
  - エラー分類が一貫する
  - DoD F-501/F-504/F-505適合
- Tasks:
  - T5.2.1: ログ出力構造統一
  - T5.2.2: 監査イベント定義と記録
  - T5.2.3: エラー分類実装

### Story S5.3 headless/CI対応（F-006, F-007）

- 要件:
  - 非対話実行で機械判定可能な結果を提供
- スコープ（やること）:
  - `--headless`
  - 終了コード規約
  - JSONLイベント出力
- スコープ（やらないこと）:
  - SaaS CI連携の専用プラグイン
- 受け入れ条件:
  - CIで終了コード判定可能
  - JSONLから状態遷移と結果が判定可能
  - DoD F-006/F-007適合
- Tasks:
  - T5.3.1: headlessモード実装
  - T5.3.2: 終了コード統一
  - T5.3.3: JSONLイベント出力実装

---

## Epic E6: エンドポイント運用

### Story S6.1 エンドポイント管理（F-301, F-302）

- 要件:
  - 複数Ollama endpoint を登録/切替できる
- スコープ（やること）:
  - `endpoint add/remove/list/use`
  - 変更履歴ログ
- スコープ（やらないこと）:
  - 自動発見
- 受け入れ条件:
  - 一覧表示と切替結果が確認可能
  - 変更前後がログで追跡可能
  - DoD F-301/F-302適合
- Tasks:
  - T6.1.1: endpointコマンド実装
  - T6.1.2: 設定永続化実装
  - T6.1.3: 運用テスト

### Story S6.2 フォールバック（F-303, F-502, F-503）

- 要件:
  - 障害時に自動切替し、試行履歴が可視化される
- スコープ（やること）:
  - ヘルス判定
  - フォールバック
  - 再試行（バックオフ）
- スコープ（やらないこと）:
  - 高度な負荷分散アルゴリズム（ラウンドロビン最適化は後続）
- 受け入れ条件:
  - 障害時に切替通知される
  - 試行回数と最終結果が追跡できる
  - DoD F-303/F-502/F-503適合
- Tasks:
  - T6.2.1: ヘルスチェック実装
  - T6.2.2: フォールバック実装
  - T6.2.3: バックオフリトライ実装

---

## Epic E7: DX拡張（Should後半）

### Story S7.1 設定スキーマ（F-601）

- 要件:
  - 不正設定を起動時に検知し、修正可能なエラーを出す
- スコープ（やること）:
  - `config.yaml` / `agent-config.yaml` バリデーション
- スコープ（やらないこと）:
  - 自動修復
- 受け入れ条件:
  - 不正フィールドが明示される
  - DoD F-601適合
- Tasks:
  - T7.1.1: スキーマ定義
  - T7.1.2: 起動時検証実装

### Story S7.2 カスタムコマンド/Recipe（F-602, F-603）

- 要件:
  - 定型手順を再利用可能にする
- スコープ（やること）:
  - カスタムコマンド読込
  - Recipe実行
- スコープ（やらないこと）:
  - 外部マーケットプレイス
- 受け入れ条件:
  - 一覧表示・実行・結果記録ができる
  - DoD F-602/F-603適合
- Tasks:
  - T7.2.1: カスタムコマンドローダ実装
  - T7.2.2: Recipe実行ランタイム実装
  - T7.2.3: 受け入れテスト

---

## Epic E8: Could群（v1.1+）

### Story S8.1 高度オーケストレーション（F-104）

- 要件: サブタスク分解と統合根拠の可視化
- スコープ（やること）: 分解計画表示、統合結果表示
- スコープ（やらないこと）: 自律的長時間計画最適化
- 受け入れ条件: DoD F-104適合
- Tasks: T8.1.1 分解器実装, T8.1.2 統合器実装

### Story S8.2 外部連携拡張（F-206, F-207, F-607）

- 要件: 外部MCP/ブラウザ/プラグインを安全に拡張
- スコープ（やること）: 権限宣言、有効/無効管理、操作履歴
- スコープ（やらないこと）: 無制限プラグイン実行
- 受け入れ条件: DoD F-206/F-207/F-607適合
- Tasks: T8.2.1 外部MCP統合, T8.2.2 ブラウザ連携, T8.2.3 プラグイン管理

### Story S8.3 運用高度化（F-304, F-604, F-605, F-606）

- 要件: 分散実行最適化と運用効率向上
- スコープ（やること）: ラウンドロビン、スケジュール、明示コンテキスト、コスト可視化
- スコープ（やらないこと）: 自動料金最適化エンジン
- 受け入れ条件: DoD F-304/F-604/F-605/F-606適合
- Tasks: T8.3.1 分散選択ロジック, T8.3.2 スケジュール実行, T8.3.3 コスト表示

---

## 2. 実行順序（推奨）

1. E1 → E2 → E3 → E4（MVP）
2. E5 → E6 → E7（Should完了）
3. E8（Could）

## 3. 完了判定

- Epic完了: 含まれるStoryがすべて受け入れ済み
- Story完了: 受け入れ条件を満たし、In/Out of scope逸脱がない
- Task完了: Storyの受け入れ条件へ寄与する検証可能な成果がある
