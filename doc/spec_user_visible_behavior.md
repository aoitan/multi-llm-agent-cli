# MultiOllamaAgentCLI ユーザー可視振る舞い仕様 v1.0

本ドキュメントは、実装内部ではなく「ユーザーから見える振る舞い」を定義する。  
対象はCLI表示、対話体験、実行中表示、結果表示、ログ/監査ファイル出力を含む。

## 1. 適用範囲

- 適用対象: `feature_list.md` の全機能（`F-001`〜`F-607`）。
- 本仕様で定義するもの:
  - 何をもって「機能ができている」とみなすか（DoD: Definition of Done）
  - ユーザーに見える表示・メッセージ・状態遷移
  - 出力ファイルの種類と含まれる情報
- 本仕様で定義しないもの:
  - クラス設計、内部データ構造、通信ライブラリなど実装詳細

デプロイ前提:
- CLI実行ノードのみ本ツールをインストール対象とする。
- リモートノードはOllama APIの提供のみを行い、Agent/MCPのインストールは不要とする。

## 2. 共通UX契約

## 2.1 実行状態の共通定義

全コマンド/タスクは、ユーザー表示上つぎの状態を持つ。

- `pending`: 受理済み・未実行
- `running`: 実行中（LLM推論/ツール実行/待機）
- `waiting_approval`: ユーザー承認待ち
- `succeeded`: 正常完了
- `failed`: 失敗完了
- `cancelled`: ユーザー取消またはポリシー停止

## 2.2 実行中表示の共通定義

- 実行中は必ず、現在の状態が視認できること。
- 最低限、次のいずれかを表示すること。
  - 状態ラベル（例: `Running`, `Waiting approval`）
  - 進行インジケータ（スピナー/進捗%/フェーズ名）
- 非対話（headless）では画面装飾を省略してよいが、同等情報をイベント出力へ含めること。

## 2.3 エラー表示の共通定義

- エラー時は「何が起きたか」「ユーザーが次に何をすべきか」を1画面で示す。
- 最低限含む情報:
  - エラー分類（`user/policy/tool/network/system`）
  - 失敗した操作（例: `shell_exec`, `endpoint use`）
  - 推奨アクション（例: `--allow-path` の追加、再試行）
  - 関連ログの参照先

## 3. 出力アーティファクト契約（ユーザー可視）

実行ごとに、少なくとも以下の情報単位を保存する。

1. 実行サマリ
- 実行ID、開始/終了時刻、終了状態、実行時間、主要エラー理由

2. イベントログ
- 状態遷移、ツール呼び出し、承認要求/承認結果、フォールバック発生、最終結果

3. 監査ログ
- 破壊的操作や権限昇格に関する「誰が・何を・なぜ・承認したか」

4. 会話/結果ログ
- ユーザー入力、最終応答、重要な中間判断（要約可）

5. エラーログ
- 失敗時の原因分類、再試行履歴、外部依存の失敗情報

補足:
- ファイル名/JSONスキーマは本書では固定しない。
- ただし、上記5情報単位は分離または明確な区分で保存されること。

## 4. 機能別 振る舞い定義（DoD）

## 4.1 コア対話・実行

### F-001 CLIチャット実行
- できている条件:
  - ユーザーが単発入力・対話入力を実行でき、応答を受け取れる。
  - 対話継続中にセッションが維持される。
- 画面表示:
  - 入力受付状態が分かる（プロンプト行または明示メッセージ）。
  - 応答完了時に完了状態を示す。
- ログ:
  - 入力、応答、実行時間、使用モデルを記録。

### F-002 ストリーミング表示
- できている条件:
  - 応答が完了前に逐次表示される。
  - 表示順序が保持され、重複表示しない。
- UX要件:
  - 「五月雨に出るだけ」では不可。実行中表示（`Generating...` など）を併記する。
  - 応答終了を明示する（done表示、改行、ステータス更新など）。
- ログ:
  - 開始時刻、最終チャンク時刻、完了判定を記録。

### F-003 モデル選択
- できている条件:
  - ユーザーが実行前に使用モデルを明示指定できる。
  - 実際に使われたモデル名を実行結果で確認できる。
- エラー時:
  - モデル未存在時、候補提示または一覧導線を表示。
- ログ:
  - 指定モデル、解決後モデル、解決規則（引数/セッション/既定）を記録。

### F-004 セッション管理
- できている条件:
  - セッション保存後、再読込で会話文脈が復元される。
- 画面表示:
  - `save/load` 成功時に保存先と対象セッションIDを表示。
- ログ:
  - セッションID、保存時点、復元時点、復元件数を記録。

### F-005 コンテキスト管理
- できている条件:
  - 履歴保持/要約/破棄がユーザー操作で制御できる。
- 画面表示:
  - 現在のコンテキスト方針（保持件数、圧縮有無）が確認できる。
- ログ:
  - 圧縮実行有無、破棄対象範囲、結果トークン削減量（概算可）を記録。

### F-006 機械可読イベント出力
- できている条件:
  - 非対話実行で、状態遷移と結果を機械判定可能な形式で出力できる。
- 表示:
  - 出力先パスを開始時に示す。
- ログ:
  - 出力ファイル作成成否、書込件数を記録。

### F-007 ヘッドレス実行
- できている条件:
  - ユーザー入力なしで実行完了し、終了コードで成否判定できる。
- UX要件:
  - 対話向け装飾を抑え、要点のみ標準出力する。
- ログ:
  - 終了コード、主失敗理由、再実行に必要な情報を記録。

## 4.2 ロールオーケストレーション

### F-101 ロール定義
- できている条件:
  - ユーザーがロールを確認でき、ロールごとの責務が表示上明確。
- ログ:
  - 実行時に実際に使われたロール構成を記録。

### F-102 ロール間タスク委譲
- できている条件:
  - 親タスクと子タスクの対応が追跡できる。
- 画面表示:
  - どのロールに委譲したかを要約表示。
- ログ:
  - 親子タスクID、委譲時刻、結果時刻、失敗理由を記録。

### F-103 複数ロール協調実行
- できている条件:
  - 複数ロールを使った実行で、最終結果と分担結果が確認できる。
- ログ:
  - ロール別処理時間、成功/失敗を記録。

### F-104 高度オーケストレーション
- できている条件:
  - タスク分解の結果（サブタスク一覧）をユーザーが確認できる。
- ログ:
  - 分解結果、統合根拠（要約可）を記録。

### F-105 ループ検知/終了条件
- できている条件:
  - ループ上限超過時に自動停止し、理由を明示。
- ログ:
  - 停止トリガー、閾値、直前の反復履歴を記録。

## 4.3 MCP・ツール連携

### F-201 MCPクライアント接続
- できている条件:
  - ツール利用時に「どのMCPツールを使ったか」が可視。
- ログ:
  - サーバー名、ツール名、呼出回数、成否を記録。

### F-202 MCP管理コマンド
- できている条件:
  - list/enable/disable/status 結果が一覧で判読可能。
- ログ:
  - 設定変更前後の状態差分を記録。

### F-203 file_read / F-204 file_write / F-205 shell_exec
- できている条件:
  - 実行可否の理由（許可/拒否）が表示される。
  - 承認が必要な場合は実行前に明示的確認を出す。
- UX要件:
  - `shell_exec` は実行中表示を必須とする。
  - `file_write` は変更対象パスを実行前に表示する。
- ログ:
  - 対象パス/コマンド、ポリシー判定、承認者、実行結果を記録。

### F-206 外部MCPサーバー連携
- できている条件:
  - 外部接続時に接続先と目的をユーザーが把握できる。
- ログ:
  - 接続先、呼出内容の要約、失敗理由を記録。

### F-207 ブラウザ操作ツール連携
- できている条件:
  - 主要操作（遷移/抽出/入力）の実施履歴が追跡できる。
- ログ:
  - URL、操作種別、抽出結果要約を記録。

## 4.4 エンドポイント・モデル運用

### F-301 登録 / F-302 切替
- できている条件:
  - 一覧確認と切替結果が即時確認できる。
- ログ:
  - 変更前後のendpoint、実行者、変更時刻を記録。

### F-303 フォールバック
- できている条件:
  - 障害時に切替発生がユーザーへ通知される。
- ログ:
  - 障害判定理由、切替先、復旧有無を記録。

### F-304 ラウンドロビン
- できている条件:
  - 分散先選択結果が追跡可能。
- ログ:
  - リクエストごとの選択先を記録。

## 4.5 セキュリティ・権限

### F-401 認証 / F-402 認可
- できている条件:
  - 未認証/未認可アクセスが明確に拒否される。
- 表示:
  - セキュリティ上過剰情報は出さず、対処可能な範囲の情報を提示。
- ログ:
  - 拒否理由カテゴリ、対象操作、発生元を記録。

### F-403 パスアクセス制御
- できている条件:
  - 許可外パスへのアクセスは必ず拒否される。
- 表示:
  - 許可方法（例: `--allow-path`）を案内。
- ログ:
  - 要求パス、判定結果、適用ポリシーを記録。

### F-404 コマンド許可レベル
- できている条件:
  - `auto/ask/deny` の差がユーザー行動として体感できる。
- 表示:
  - `ask` は毎回明示確認を表示。
- ログ:
  - 判定モードと最終結果を記録。

### F-405 権限モード切替
- できている条件:
  - 現在モードが常時確認でき、切替時に警告が出る。
- ログ:
  - モード変更履歴、変更者、変更理由を記録。

### F-406 危険コマンド防止
- できている条件:
  - 危険操作は拒否または強制確認される。
- ログ:
  - マッチした危険判定ルールを記録。

## 4.6 信頼性・運用・監査

### F-501 エラー分類と処理方針
- できている条件:
  - 同種エラーで一貫した表示・終了コードになる。
- ログ:
  - 分類、原因、再試行有無を記録。

### F-502 リトライ/バックオフ
- できている条件:
  - リトライ中であることを表示し、最終結果を明示。
- ログ:
  - 試行回数、間隔、最終判定を記録。

### F-503 ヘルスチェック
- できている条件:
  - 健全/異常が一覧で判断できる。
- ログ:
  - 対象、チェック時刻、結果を記録。

### F-504 構造化ログ
- できている条件:
  - 人間可読と機械可読の双方で追跡できる。
- 表示:
  - ログ格納先を確認可能。

### F-505 監査ログ
- できている条件:
  - 事後に「誰が何を承認したか」を再現できる。
- ログ:
  - actor, action, target, reason, approval を必須保持。

### F-506 チェックポイント/ロールバック
- できている条件:
  - ユーザーが復元可能な復元点を選択できる。
- 表示:
  - 復元実行時に影響範囲を事前提示。
- ログ:
  - 復元元ID、復元対象、結果を記録。

## 4.7 開発者体験・拡張

### F-601 設定スキーマ
- できている条件:
  - 不正設定は起動時に検知され、修正箇所が分かる。
- ログ:
  - 検証失敗箇所と理由を記録。

### F-602 カスタムコマンド
- できている条件:
  - ユーザー定義コマンドが一覧表示され、実行できる。
- ログ:
  - 実行したカスタムコマンド名と成否を記録。

### F-603 Recipe/Prompt Pack
- できている条件:
  - 定型手順を選択実行でき、手順進行が可視。
- ログ:
  - レシピID、実行ステップ、最終成否を記録。

### F-604 スケジュール実行
- できている条件:
  - 予定登録・次回実行時刻・直近結果が確認できる。
- ログ:
  - スケジュール設定変更履歴、実行結果を記録。

### F-605 明示的コンテキスト指定
- できている条件:
  - `@file` などで指定した対象が実際に利用されたと確認できる。
- ログ:
  - 指定対象一覧と解決結果を記録。

### F-606 コスト可視化/圧縮
- できている条件:
  - 実行ごとの概算コスト/トークン情報を確認できる。
- ログ:
  - 入出力トークン、圧縮有無、圧縮率を記録。

### F-607 プラグイン機構
- できている条件:
  - 有効/無効状態と権限範囲が確認できる。
- ログ:
  - プラグイン名、バージョン、使用権限、呼出履歴を記録。

## 5. 最低受け入れ判定（横断）

機能が「できている」と言うために、最低限つぎを満たすこと。

1. ユーザーが操作結果を即時に判断できる表示がある。  
2. 実行中であること、待機中であること、完了/失敗したことが区別できる。  
3. 後追い検証できるログ/監査情報が残る。  
4. 拒否時は拒否理由と次アクションが示される。  
5. headless実行でも同等の判定情報が取得できる。

## 6. 関連ドキュメント

- 機能一覧: [./feature_list.md](./feature_list.md)
- 理想仕様: [./specification_ideal_v1.md](./specification_ideal_v1.md)
- 機能別仕様インデックス: [./features/README.md](./features/README.md)
- 配置モデル仕様: [./deployment_model_single_control_node.md](./deployment_model_single_control_node.md)
