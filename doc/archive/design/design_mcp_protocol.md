# MCP (Model Context Protocol) の設計

## 概要

MCPは、アプリケーションがLLMにコンテキストを提供する方法を標準化するオープンプロトコルです。本ドキュメントでは、MCPの公式仕様（JSON-RPC 2.0ベース）に基づいたプロトコル設計について記述します。

## 通信モデル

MCPクライアントとMCPサーバー間の通信にはWebSocketを使用し、その上でJSON-RPC 2.0プロトコルを実装します。

## JSON-RPC 2.0 メッセージ構造

すべてのメッセージはJSON-RPC 2.0の仕様に従います。

### リクエスト (Request)

```json
{
  "jsonrpc": "2.0",
  "id": "<リクエストID>",
  "method": "<メソッド名>",
  "params": {
    /* メソッドに応じたパラメータ */
  }
}
```

### レスポンス (Response)

```json
{
  "jsonrpc": "2.0",
  "id": "<リクエストID>",
  "result": {
    /* 結果データ */
  }
}
```

### エラー (Error)

```json
{
  "jsonrpc": "2.0",
  "id": "<リクエストID>",
  "error": {
    "code": <エラーコード>,
    "message": "<エラーメッセージ>",
    "data": { /* オプションのエラーデータ */ }
  }
}
```

### 通知 (Notification)

```json
{
  "jsonrpc": "2.0",
  "method": "<メソッド名>",
  "params": {
    /* メソッドに応じたパラメータ */
  }
}
```

## 主要なメソッドと通知

### クライアント -> サーバー

#### `initialize` (Request)

クライアントがサーバーとの接続を初期化する際に送信します。

#### `roots/list` (Request)

クライアントが公開しているファイルシステム上のルート（ディレクトリ）のリストをサーバーに要求します。

#### `textDocument/didOpen` (Notification)

クライアントがテキストドキュメントを開いたことをサーバーに通知します。

#### `textDocument/didChange` (Notification)

クライアントがテキストドキュメントを変更したことをサーバーに通知します。

#### `textDocument/didClose` (Notification)

クライアントがテキストドキュメントを閉じたことをサーバーに通知します。

### サーバー -> クライアント

#### `initialized` (Notification)

サーバーが初期化を完了したことをクライアントに通知します。

#### `notifications/roots/list_changed` (Notification)

サーバーがクライアントに公開されているルートのリストが変更されたことを通知します。

## コンテキスト管理の概念

MCPサーバーは、クライアントから提供されるルート情報やドキュメントの変更通知を基に、LLMが利用できるコンテキストを構築・管理します。

## 今後の検討事項

- 各メソッド/通知の詳細なパラメータ定義
- エラーコードの定義
- 認証・認可の仕組み
- ツール利用のためのメソッド/通知
- 複数LLMエンドポイントのオーケストレーションに関するメソッド/通知
