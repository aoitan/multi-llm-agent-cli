# 開発ロードマップ（新仕様準拠）

本ロードマップは以下を前提とする。

- 理想仕様: `/Users/aoitan/workspace/mla_work/codex/doc/specification_ideal_v1.md`
- ユーザー可視振る舞い仕様: `/Users/aoitan/workspace/mla_work/codex/doc/spec_user_visible_behavior.md`
- 配置モデル: `/Users/aoitan/workspace/mla_work/codex/doc/deployment_model_single_control_node.md`
- タスク分解: `/Users/aoitan/workspace/mla_work/codex/doc/task_breakdown_epic_story_task.md`

## フェーズ0: 仕様固定と移行準備

### 0.1 仕様の基準化
- `feature_list.md` を機能要件の基準とする
- `F-001`〜`F-607` のIDを実装・テスト・ログで共通利用する

### 0.2 旧仕様の隔離完了
- 旧仕様/旧設計を `doc/archive/` に隔離（完了済み）
- 新規作業は `specification_ideal_v1.md` 系のみ参照

## フェーズ1: Control Node基盤（MVP）

### 1.1 Single Control Node実装
- CLI実行ノードに Orchestrator/Role Runtime/MCP連携を集約
- リモートマシンは Ollama endpoint のみ待機

### 1.2 コア機能実装（Must）
- `F-001` CLIチャット実行
- `F-002` ストリーミング表示
- `F-003` モデル選択
- `F-004` セッション管理
- `F-005` コンテキスト管理

### 1.3 ロールオーケストレーション実装（Must）
- `F-101` ロール定義
- `F-102` ロール間タスク委譲

### 1.4 MCP基盤実装（Must）
- `F-201` MCPクライアント接続
- `F-202` MCP管理コマンド
- `F-203` `file_read`
- `F-204` `file_write`
- `F-205` `shell_exec`

### 1.5 セキュリティ最小要件（Must）
- `F-401` 認証
- `F-402` 認可
- `F-403` パスアクセス制御
- `F-404` コマンド許可レベル
- `F-406` 危険コマンド防止

### 1.6 受け入れ条件
- `F-001`〜`F-005`, `F-101`, `F-102`, `F-201`〜`F-205`, `F-401`〜`F-404`, `F-406` が受け入れ済み
- ユーザー可視振る舞い仕様のDoDを満たす

## フェーズ2: ユーザー可視品質と運用強化（Should）

### 2.1 UX/自動化強化
- `F-006` 機械可読イベント出力
- `F-007` ヘッドレス実行
- 実行状態表示（running/waiting_approval等）の一貫化

### 2.2 ロール並行実行
- `F-103` 複数ロール協調実行
- `F-105` ループ検知/終了条件

### 2.3 エンドポイント運用強化
- `F-301` 複数エンドポイント登録
- `F-302` エンドポイント切替
- `F-303` フォールバック

### 2.4 信頼性・監査
- `F-501` エラー分類と処理方針
- `F-502` リトライ/バックオフ
- `F-503` ヘルスチェック
- `F-504` 構造化ログ
- `F-505` 監査ログ
- `F-506` チェックポイント/ロールバック

### 2.5 開発者体験
- `F-601` 設定スキーマ検証
- `F-602` カスタムコマンド
- `F-603` Recipe/Prompt Pack

### 2.6 受け入れ条件
- `Must` + `Should` の全機能が受け入れ済み
- headless実行でCI判定可能
- 監査ログで承認・権限変更・破壊操作の追跡可能

## フェーズ3: 高度化（Could）

### 3.1 オーケストレーション高度化
- `F-104` 高度オーケストレーション

### 3.2 MCP/外部連携高度化
- `F-206` 外部MCPサーバー連携
- `F-207` ブラウザ操作ツール連携

### 3.3 モデル運用高度化
- `F-304` ラウンドロビン

### 3.4 拡張機能
- `F-604` スケジュール実行
- `F-605` 明示的コンテキスト指定
- `F-606` コスト可視化/圧縮
- `F-607` プラグイン機構

## フェーズ4: スケール対応

### 4.1 境界固定の維持
- タスク状態、イベント、監査の契約互換を維持
- 実行バックエンド差し替え可能な構造を維持

### 4.2 ボトルネック分離
- Control Node高負荷機能を段階的に分離
- 分離後もユーザー可視振る舞い契約を不変に保つ

## 進捗管理ルール

1. 完了定義は「実装完了」ではなく「ユーザー可視振る舞いDoD達成」とする。  
2. 各フェーズで `Must/Should/Could` の優先順位を崩さない。  
3. 仕様変更は `specification_ideal_v1.md` と `spec_user_visible_behavior.md` を同時更新する。  
